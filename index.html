<!DOCTYPE HTML>
<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:600,300' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="css/main.css"/>
    <link rel="stylesheet" type="text/css" href="css/selector.css"/>
    
    <script src="js/api.js"></script>
    <script src="js/config.js"></script>
    <script>
        var earth;
        var audioPlayer;
        var latLong, pLatLong = [0, 0];
        var markers=[];
        var mCount=0;
        var id, pid;
        var elemArt, elemSong, elemArtist;
        var elemSort, elemOpts;
        
        var data;
        var shown=false;
        
        function initialize() {
            earth = new WE.map('earth_div');
            WE.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(earth);
            setInterval(loop, 10000);
            audioPlayer=document.getElementById("audio");
            elemArt=document.getElementById("albumArt");
            elemSong=document.getElementById("songName");
            elemArtist=document.getElementById("artistName");
            elemSort=document.getElementById("sort");
            elemOpts=document.getElementById("hiddenOptions");
        }
        function loop() 
        {
            latLong = earth.getCenter();
            if ((Math.abs(latLong[0] - pLatLong[0]) + Math.abs(latLong[1] - pLatLong[1])) * earth.getZoom() > 20)
            {
                console.log((Math.abs(latLong[0] - pLatLong[0]) + Math.abs(latLong[1] - pLatLong[1])));
                pLatLong = latLong;
                playPopularMusic(latLong);
            }
        }
        function playSpotifyTrack(trackID, artist, song) 
        {
            var x = new XMLHttpRequest();
            var theURL="https://api.spotify.com/v1/tracks/"+trackID;
            x.open("GET", theURL, false);
            x.send(null);
            console.log(x.responseText);
            var sData=JSON.parse(x.responseText);
            var songSrc=sData.preview_url;
            audioPlayer.setAttribute("src", songSrc);
            audioPlayer.play();
            if(sData.album.images.length==3){
                elemArt.setAttribute("src",sData.album.images[2].url);
            }
            elemSong.innerHTML=song;
            elemArtist.innerHTML=artist;
            for(var i=0;i<sData.album.images.length;i++){
                var img=sData.album.images[i];
                console.log(img.width);
            }
            
        }
        function playPopularMusic(latLong) 
        {
            bounds = earth.getBounds();
            if (bounds == null) 
            {
                console.log("hey!");
            } 
            else 
            {
                console.log("boo!");
                var x = new XMLHttpRequest();
                theURL = "http://developer.echonest.com/api/v4/song/search?"+
                        "api_key="+config.EchoNestAPI+
                        "&format=json"+
                        "&results=1"+
                        "&bucket=id:spotify"+
                        "&bucket=tracks"+
                        "&bucket=artist_location"+
                        "&bucket=song_type"+
                        "&min_longitude="+bounds[2]+
                        "&max_longitude="+bounds[3]+
                        "&min_latitude="+bounds[0]+
                        "&max_latitude=" + bounds[1];
                if(!(elemSort.value==="")){
                    theURL+="&sort="+elemSort.value;
                }
                        
                x.open("GET", theURL, false);
                x.send(null);
                //console.log(x.responseText);
                data = JSON.parse(x.responseText);
                if (data != null) 
                {
                    if (data.response.status.code == "0") 
                    {
                        playable=(data.response.songs[0].tracks.length>0);
                        artist = data.response.songs[0].artist_name;
                        song = data.response.songs[0].title;
                        id = data.response.songs[0].id;
                        markers[mCount]=WE.marker([data.response.songs[0].artist_location.latitude, 
                                            data.response.songs[0].artist_location.longitude]);
                        markers[mCount].addTo(earth)
                        markers[mCount].bindPopup("<b>"+song+"</b></br><i>by "+artist + "</i>"+
                                                    ((!playable)?"<br/>Unfortunately, this song is not available on Spotify":""));
                        markers[mCount].openPopup();
                        if(mCount>0)
                            markers[mCount-1].closePopup();
                            
                        mCount++;
                            
                        if (playable && id != pid) 
                        {
                            pid=id;
                            spotifyID=data.response.songs[0].tracks[0].foreign_id;
                            playSpotifyTrack(spotifyID.substr(spotifyID.lastIndexOf(':')+1), artist, song);
                        }
                    }
                }
            }
        }
        function showE(el){
            if(!shown){
                elemOpts.setAttribute("class", "shown");
                el.innerHTML='-';
            }else{
                elemOpts.setAttribute("class", "");
                el.innerHTML='+';
            }
            shown=!shown;

                
        }
    </script>
    <title>SongSpace</title>
  </head>
  <body onload="initialize()">
    <div id="earth_div"></div>
    <div id="musicBox">
    <span id="mainBox">
        <img id="albumArt"></img><div id="songInfo">
        <b id="songName"></b> <br/><span id="artistName"></span></div><br/>
        <audio id="audio" controls>
        Your browser does not support the audio element, which is rather unfortunate? Um. This site won't really do much for ou, then.
        </audio>
    </span> 
    <span id="hiddenOptions">
    Select song by
    <section>
            <select class="cs-select cs-skin-underline" id="sort">
                    <option value="song_hotttnesss-desc">Song Popularity</option>
                    <option value="artist_hotttnesss-desc">Artist Popularity</option>
                    <option value="artist_familiarity-desc">Artist Familiarity</option>
                    <option value="">Random</option>
            </select>
    </section>
    </span>
    <span id="extender" onclick="showE(this)">
    +
    </span>
    </div>
    <script src="js/classie.js"></script>
    <script src="js/selectFx.js"></script>
    <script>
            (function() {
                    [].slice.call( document.querySelectorAll( 'select.cs-select' ) ).forEach( function(el) {        
                            new SelectFx(el);
                    } );
            })();
    </script>

  </body>
</html>